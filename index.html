<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>iRacing 레이스 성향 & 스포츠카 이상형 월드컵</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      display: flex;
      justify-content: center;
    }
    .app {
      max-width: 1080px;
      width: 100%;
      padding: 24px 16px 40px;
    }
    h1 {
      font-size: 26px;
      text-align: center;
      margin: 8px 0 4px;
    }
    .subtitle {
      text-align: center;
      font-size: 14px;
      color: #9ca3af;
      margin-bottom: 24px;
    }
    .steps {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .step-pill {
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #9ca3af;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .step-pill.active {
      border-color: #38bdf8;
      background: #0f172a;
      color: #e5e7eb;
    }
    .step-number {
      background: #111827;
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 11px;
    }
    .step-pill.active .step-number {
      background: #0369a1;
    }

    section {
      margin-bottom: 32px;
      padding: 16px 16px 20px;
      border-radius: 18px;
      border: 1px solid #1f2937;
      background: radial-gradient(circle at top, rgba(15,118,110,0.18), transparent 60%);
    }
    section.inactive {
      opacity: 0.4;
    }
    section h2 {
      font-size: 18px;
      margin-top: 0;
      margin-bottom: 8px;
    }
    .section-desc {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 16px;
    }

    /* Step 1 */
    .license-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }
    .license-card {
      border-radius: 16px;
      border: 1px solid #1f2937;
      padding: 14px 14px 16px;
      background: #020617;
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease, background 0.12s ease;
    }
    .license-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 30px rgba(0,0,0,0.55);
      border-color: #4b5563;
      background: #030712;
    }
    .license-card.selected {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56,189,248,0.3);
      background: radial-gradient(circle at top, rgba(56,189,248,0.1), #020617);
    }
    .license-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .license-badge {
      font-weight: 800;
      font-size: 18px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #111827;
      border: 1px solid #1f2937;
    }
    .license-title {
      font-size: 14px;
      font-weight: 600;
    }
    .license-body {
      font-size: 13px;
      color: #d1d5db;
      line-height: 1.5;
    }
    .license-note {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 6px;
    }
    .license-result {
      margin-top: 12px;
      font-size: 13px;
      color: #a5b4fc;
    }

    .btn-row {
      margin-top: 14px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      flex-wrap: wrap;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 7px 16px;
      font-size: 13px;
      cursor: pointer;
      background: #1d4ed8;
      color: #f9fafb;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.12s ease, transform 0.08s ease, box-shadow 0.12s ease;
    }
    button:hover {
      background: #2563eb;
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(15,23,42,0.6);
    }
    button.secondary {
      background: #111827;
      color: #e5e7eb;
    }
    button.secondary:hover {
      background: #1f2937;
    }
    button:disabled {
      opacity: 0.45;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    /* Step 2 */
    .match-info {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 10px;
    }
    .match-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
      margin-bottom: 10px;
    }
    .car-card {
      border-radius: 18px;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 14px 14px 16px;
      cursor: pointer;
      text-align: left;
      transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease, background 0.12s ease;
    }
    .car-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 30px rgba(0,0,0,0.55);
      border-color: #4b5563;
      background: #030712;
    }
    .car-name {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .car-class {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 6px;
    }
    .tag-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 6px;
    }
    .tag {
      font-size: 10px;
      border-radius: 999px;
      padding: 2px 7px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #9ca3af;
    }
    .car-note {
      font-size: 11px;
      color: #6b7280;
    }
    .wc-status {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 4px;
    }
    .winner-text {
      margin-top: 6px;
      font-size: 15px;
      font-weight: 800;
      color: #facc15;
    }

    /* Step 3 */
    .summary-line {
      font-size: 13px;
      margin-bottom: 4px;
    }
    .summary-highlight {
      color: #a5b4fc;
      font-weight: 600;
    }
    .cost-box {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      background: #020617;
      border: 1px solid #1f2937;
      font-size: 13px;
    }
    .cost-line {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }
    .cost-label {
      color: #9ca3af;
    }
    .cost-value {
      font-weight: 600;
    }
    .cost-note {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
      line-height: 1.5;
    }

    @media (max-width: 720px) {
      .license-grid {
        grid-template-columns: 1fr;
      }
      .match-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>iRacing 레이스 성향 & 스포츠카 이상형 월드컵</h1>
    <div class="subtitle">
      ① 레이스 성향 → ② 스포츠카 이상형 월드컵 → ③ 2025 시즌4 기준 유료 컨텐츠 대략 비용
    </div>

    <div class="steps">
      <div class="step-pill active" id="step-pill-1">
        <span class="step-number">1</span> 레이스 성향
      </div>
      <div class="step-pill" id="step-pill-2">
        <span class="step-number">2</span> 차량 이상형 월드컵
      </div>
      <div class="step-pill" id="step-pill-3">
        <span class="step-number">3</span> 2025 S4 유료 컨텐츠 비용
      </div>
    </div>

    <!-- STEP 1 -->
    <section id="step1">
      <h2>1단계. 레이스 성향(라이센스 타입)을 골라보세요</h2>
      <div class="section-desc">
        실제 iRacing 라이센스가 아니라, <b>당신의 레이스 스타일을 설명하는 가상의 라이센스</b>예요.<br />
        느낌에 가장 가까운 걸 하나 골라주세요.
      </div>
      <div class="license-grid">
        <div class="license-card" data-license="A">
          <div class="license-header">
            <div>
              <div class="license-title">A 라이센스 · 젠틀맨 리그</div>
            </div>
            <div class="license-badge">A</div>
          </div>
          <div class="license-body">
            <b>클린 레이스</b>를 최우선으로 생각해요.  
            약간 밀려도 참을 수 있고, 억지 dive bomb은 안 하는 타입.
            <div class="license-note">
              - 인시던트 적고, 롱런 페이스 관리 중시<br />
              - “끝까지 같이 달리자” 분위기를 좋아함
            </div>
          </div>
        </div>
        <div class="license-card" data-license="B">
          <div class="license-header">
            <div class="license-title">B 라이센스 · 치열한 생존 경쟁</div>
            <div class="license-badge">B</div>
          </div>
          <div class="license-body">
            포지션 싸움, 사이드 바이 사이드 배틀을 좋아해요.  
            <b>적당히 밀어붙이지만 선 넘지 않는</b> 생존 경쟁 타입.
            <div class="license-note">
              - 브레이킹 배틀, 디펜스/오버테이크 즐김<br />
              - 인시던트는 조금 나도 레이스 재미 우선
            </div>
          </div>
        </div>
        <div class="license-card" data-license="C">
          <div class="license-header">
            <div class="license-title">C 라이센스 · 전손을 각오한 코너 사바사</div>
            <div class="license-badge">C</div>
          </div>
          <div class="license-body">
            코너마다 <b>“여기서 안 넣으면 오늘 못 잔다”</b> 마인드.  
            전손도 감수하고 사바사 거는 타입.
            <div class="license-note">
              - 막코너 dive bomb 자주 고민함<br />
              - 리스크 감수하고 하이라이트 노리는 스타일
            </div>
          </div>
        </div>
        <div class="license-card" data-license="D">
          <div class="license-header">
            <div class="license-title">D 라이센스 · 범퍼카 모드</div>
            <div class="license-badge">D</div>
          </div>
          <div class="license-body">
            진지한 레이스보다는 <b>친구들이랑 웃고 떠드는 범퍼카 느낌</b>.  
            접촉도 개그 요소 정도로 받아들이는 타입.
            <div class="license-note">
              - 파티 레이스, 망겜(?)도 즐김<br />
              - “이 판은 그냥 웃자” 마인드
            </div>
          </div>
        </div>
      </div>
      <div class="license-result" id="license-result">
        라이센스를 선택하면 2단계가 열립니다.
      </div>
      <div class="btn-row">
        <button id="to-step2" disabled>
          2단계로 이동 (차량 월드컵 시작)
        </button>
      </div>
    </section>

    <!-- STEP 2 -->
    <section id="step2" class="inactive">
      <h2>2단계. 스포츠카 이상형 월드컵 (32강)</h2>
      <div class="section-desc">
        iRacing <b>스포츠카 계열 공식 차량 DB</b>를 기반으로 한 32강 토너먼트예요.<br />
        더 끌리는 차를 계속 고르다 보면 최종 이상형 1대가 남습니다.
      </div>
      <div class="match-info" id="match-info">
        라이센스를 먼저 선택해 주세요.
      </div>
      <div class="btn-row" style="margin-top: 0; margin-bottom: 10px;">
        <button id="start-wc" disabled>이상형 월드컵 시작하기</button>
        <button id="shuffle-wc" class="secondary" disabled>차 목록 섞기</button>
      </div>
      <div class="match-grid" id="match-grid"></div>
      <div class="wc-status" id="wc-status"></div>
      <div class="winner-text" id="winner-text"></div>
      <div class="btn-row">
        <button id="restart-wc" class="secondary" disabled>월드컵 다시하기</button>
      </div>
    </section>

    <!-- STEP 3 -->
    <section id="step3" class="inactive">
      <h2>3단계. 2025 시즌4 기준 유료 컨텐츠 대략 비용</h2>
      <div class="section-desc">
        2단계에서 뽑힌 차량을 기준으로,<br />
        2025 시즌4 B클래스 스포츠카 시리즈(주로 GT3/GT4/컵/프로토 타입)를 풀시즌 뛴다고 가정했을 때의
        <b>유료 차량/트랙 대략 비용</b>을 계산합니다.
      </div>

      <div id="summary-text">
        먼저 월드컵을 통해 차량을 선택해 주세요.
      </div>

      <div id="cost-box" class="cost-box" style="display:none;">
        <div class="cost-line">
          <div class="cost-label">차량 라이센스 (유료)</div>
          <div class="cost-value" id="cost-car"></div>
        </div>
        <div class="cost-line">
          <div class="cost-label">유료 트랙 개수 (추정)</div>
          <div class="cost-value" id="cost-tracks-count"></div>
        </div>
        <div class="cost-line">
          <div class="cost-label">트랙 라이센스 총액 (정가 기준)</div>
          <div class="cost-value" id="cost-tracks"></div>
        </div>
        <div class="cost-line">
          <div class="cost-label">합계 (정가 기준)</div>
          <div class="cost-value" id="cost-total"></div>
        </div>
        <div class="cost-line">
          <div class="cost-label">합계 (여러 개 묶음 구매 할인 추정)</div>
          <div class="cost-value" id="cost-total-discount"></div>
        </div>
        <div class="cost-note">
          ※ iRacing 공식 가격 기준: <b>차량 1대 $11.95, 트랙 1개 $14.95(대부분)</b>를 사용한 대략치입니다.<br />
          ※ 시즌4 2025 스포츠카/GT3/GT4/컵/프로토 시리즈는 보통 <b>유료 트랙 9~12개</b>로 구성되어 있어,
          차량/클래스별로 대표 시리즈를 기준으로 추정했습니다.<br />
          ※ 실제 지출은 <b>무료 베이스 트랙 사용 여부, 일부 주차 불참, 세일/할인</b> 등에 따라 더 낮아질 수 있습니다.
        </div>
      </div>
    </section>
  </div>

  <script>
    // ====== 기본 상수 (iRacing 가격, 2025 기준 대략치) ======
    const CAR_PRICE = 11.95;   // 유료 차량 1대
    const TRACK_PRICE = 14.95; // 유료 트랙 1개 (상위구간 기준)
    const BULK_DISCOUNT = 0.15; // 6개 이상 한 번에 사는 경우 15% 할인 가정

    // ====== 설문 상태 ======
    const state = {
      license: null,      // "A" | "B" | "C" | "D"
      licenseLabel: null, // 텍스트
      winnerCar: null     // { name, cls, tags, series, paidTracks, paidCar }
    };

    // ====== STEP 1: 레이스 성향 선택 ======
    const licenseCards = document.querySelectorAll(".license-card");
    const licenseResultEl = document.getElementById("license-result");
    const toStep2Btn = document.getElementById("to-step2");

    const licenseTexts = {
      A: "A 라이센스 · 젠틀맨 리그",
      B: "B 라이센스 · 치열한 생존 경쟁",
      C: "C 라이센스 · 전손을 각오한 코너 사바사",
      D: "D 라이센스 · 범퍼카 모드"
    };

    licenseCards.forEach(card => {
      card.addEventListener("click", () => {
        licenseCards.forEach(c => c.classList.remove("selected"));
        card.classList.add("selected");

        const lic = card.dataset.license;
        state.license = lic;
        state.licenseLabel = licenseTexts[lic];

        licenseResultEl.textContent = `선택한 성향: ${state.licenseLabel}`;
        toStep2Btn.disabled = false;

        // Step 2 활성화
        document.getElementById("step2").classList.remove("inactive");
        document.getElementById("step-pill-2").classList.add("active");
        document.getElementById("start-wc").disabled = false;
        document.getElementById("shuffle-wc").disabled = false;
      });
    });

    toStep2Btn.addEventListener("click", () => {
      document.getElementById("step1").scrollIntoView({ behavior: "smooth", block: "start" });
      setTimeout(() => {
        document.getElementById("step2").scrollIntoView({ behavior: "smooth", block: "start" });
      }, 100);
    });

    // ====== STEP 2: 차량 DB (공식 리스트 기반, 스포츠/GT 계열만 추출) ======
    // paidTracks: 해당 차량이 포함된 B클래스 대표 시리즈(2025 S4 기준)에서
    // 풀시즌 출전을 가정했을 때 필요한 유료 트랙 개수를 "대략" 넣은 값
    // series: 어떤 계열인지 간단 설명 (성향 연결용)
    const baseCars = [
      // GT3 (B 라이센스 스포츠카 메인)
      {
        name: "Aston Martin Vantage GT3 EVO",
        cls: "GT3",
        series: "B · GT3 메인 / IMSA, GT Sprint 등",
        tags: ["GT3", "B 라이센스", "2025 S4 신규", "메타"],
        paidTracks: 11,
        paidCar: true
      },
      {
        name: "BMW M4 GT3",
        cls: "GT3",
        series: "B · GT3 Challenge / Regional Tour",
        tags: ["GT3", "B 라이센스", "밸런스형", "인기차"],
        paidTracks: 11,
        paidCar: true
      },
      {
        name: "Ferrari 296 GT3",
        cls: "GT3",
        series: "B · GT3 / 내구",
        tags: ["GT3", "B 라이센스", "코너링", "페라리"],
        paidTracks: 11,
        paidCar: true
      },
      {
        name: "Mercedes-AMG GT3 2020",
        cls: "GT3",
        series: "B · GT3 / 멀티클래스",
        tags: ["GT3", "B 라이센스", "안정적", "내구"],
        paidTracks: 11,
        paidCar: true
      },
      {
        name: "Lamborghini Huracán GT3 EVO",
        cls: "GT3",
        series: "B · GT3 / 내구",
        tags: ["GT3", "B 라이센스", "코너 공격적", "인기"],
        paidTracks: 11,
        paidCar: true
      },
      {
        name: "Audi R8 LMS EVO II GT3",
        cls: "GT3",
        series: "B · GT3 / 뉘르부르크링 등",
        tags: ["GT3", "B 라이센스", "테크니컬", "아우디"],
        paidTracks: 11,
        paidCar: true
      },
      {
        name: "Chevrolet Corvette Z06 GT3.R",
        cls: "GT3",
        series: "B · GT3 / IMSA GTD",
        tags: ["GT3", "B 라이센스", "미국 GT", "내구"],
        paidTracks: 11,
        paidCar: true
      },
      {
        name: "Ford Mustang GT3",
        cls: "GT3",
        series: "B · GT3 / GT Endurance",
        tags: ["GT3", "B 라이센스", "V8 사운드", "머슬감성"],
        paidTracks: 11,
        paidCar: true
      },

      // GTE (아직도 B클래스 시리즈 존재)
      {
        name: "Ferrari 488 GTE",
        cls: "GTE",
        series: "B · GTE Sprint",
        tags: ["GTE", "B 라이센스", "페라리", "클래식"],
        paidTracks: 11,
        paidCar: true
      },
      {
        name: "BMW M8 GTE",
        cls: "GTE",
        series: "B · GTE Sprint / 내구",
        tags: ["GTE", "B 라이센스", "고속 안정성", "BMW"],
        paidTracks: 11,
        paidCar: true
      },
      {
        name: "Porsche 911 RSR (GTE)",
        cls: "GTE",
        series: "B · GTE",
        tags: ["GTE", "B 라이센스", "사운드", "포르쉐"],
        paidTracks: 11,
        paidCar: true
      },
      {
        name: "Chevrolet Corvette C8.R GTE",
        cls: "GTE",
        series: "B · GTE",
        tags: ["GTE", "B 라이센스", "미국 GT", "르망"],
        paidTracks: 11,
        paidCar: true
      },

      // GT4 (일부 B 또는 C/B 전환 시리즈 기준)
      {
        name: "BMW M4 GT4 (G82)",
        cls: "GT4",
        series: "B/C · GT4 시리즈",
        tags: ["GT4", "밸런스형", "엔트리 로드", "BMW"],
        paidTracks: 10,
        paidCar: true
      },
      {
        name: "Aston Martin Vantage GT4",
        cls: "GT4",
        series: "B/C · GT4",
        tags: ["GT4", "코너링", "브리티시", "엔트리~중급"],
        paidTracks: 10,
        paidCar: true
      },
      {
        name: "Mercedes-AMG GT4",
        cls: "GT4",
        series: "B/C · GT4",
        tags: ["GT4", "파워풀", "ABS/TC 친절", "메르세데스"],
        paidTracks: 10,
        paidCar: true
      },
      {
        name: "Porsche 718 Cayman GT4 Clubsport MR",
        cls: "GT4",
        series: "B/C · GT4",
        tags: ["GT4", "포르쉐", "미드십", "밸런스 좋음"],
        paidTracks: 10,
        paidCar: true
      },
      {
        name: "McLaren 570S GT4",
        cls: "GT4",
        series: "B/C · GT4",
        tags: ["GT4", "맥라렌", "테크니컬", "트랙데이 감성"],
        paidTracks: 10,
        paidCar: true
      },
      {
        name: "Ford Mustang GT4",
        cls: "GT4",
        series: "B/C · GT4",
        tags: ["GT4", "머슬카 느낌", "2025 S4 신규", "V8"],
        paidTracks: 10,
        paidCar: true
      },

      // 컵 / 원메이크 / 엔트리 스포츠카
      {
        name: "Porsche 911 GT3 Cup (992)",
        cls: "Cup",
        series: "B · 컵 / Nurburgring Endurance 등",
        tags: ["컵카", "노 ABS", "하드코어", "포르쉐"],
        paidTracks: 9,
        paidCar: true
      },
      {
        name: "Ferrari 296 Challenge",
        cls: "Challenge",
        series: "B · 페라리 원메이크",
        tags: ["원메이크", "페라리", "하드코어 컵", "트랙데이"],
        paidTracks: 9,
        paidCar: true
      },
      {
        name: "BMW M2 CS Racing",
        cls: "Cup",
        series: "B/C · 컵 / 엔트리",
        tags: ["컵카", "B/C 라이센스", "연습용", "BMW"],
        paidTracks: 9,
        paidCar: true
      },

      {
        name: "Global Mazda MX-5 Cup",
        cls: "Entry",
        series: "Rookie/C · 무료 베이스 / 엔트리 로드",
        tags: ["무료 베이스", "엔트리", "클린 레이스", "연습용"],
        paidTracks: 0, // 기본 무료 트랙 조합이 많으므로 0으로 처리
        paidCar: false
      },
      {
        name: "Toyota GR86",
        cls: "Entry",
        series: "Rookie/C · 무료 베이스 / 엔트리 로드",
        tags: ["무료 베이스", "엔트리", "GR86 컵", "슬라이드 연습"],
        paidTracks: 0,
        paidCar: false
      },

      // TCR (투어링이지만 스포츠카 느낌 레이스)
      {
        name: "Hyundai Elantra N TCR",
        cls: "TCR",
        series: "B · TCR / 투어링",
        tags: ["TCR", "전륜", "타임어택 느낌", "B 라이센스"],
        paidTracks: 9,
        paidCar: true
      },
      {
        name: "Honda Civic Type R TCR",
        cls: "TCR",
        series: "B · TCR / 투어링",
        tags: ["TCR", "전륜", "코너 배틀", "혼다"],
        paidTracks: 9,
        paidCar: true
      },

      // 프로토 타입 / 하이브리드 (상위 스포츠 프로토타입)
      {
        name: "Dallara P217 LMP2",
        cls: "LMP2",
        series: "B · LMP2 Challenge / 내구",
        tags: ["LMP2", "B 라이센스", "멀티클래스", "내구"],
        paidTracks: 11,
        paidCar: true
      },
      {
        name: "Ligier JS P320 (LMP3)",
        cls: "LMP3",
        series: "B/C · LMP3 / 내구",
        tags: ["LMP3", "엔트리 프로토", "코스트 효율", "내구"],
        paidTracks: 10,
        paidCar: true
      },
      {
        name: "BMW M Hybrid V8",
        cls: "GTP",
        series: "A/B · IMSA GTP",
        tags: ["GTP", "프로토타입", "하이브리드", "상위리그"],
        paidTracks: 11,
        paidCar: true
      },

      // Radical & Mission R (하드코어 스포츠 프로토 타입)
      {
        name: "Radical SR10",
        cls: "Radical",
        series: "B/C · Radical / 랩타임 머신",
        tags: ["라디컬", "하드코어", "에어로", "타임어택"],
        paidTracks: 9,
        paidCar: true
      },
      {
        name: "Radical SR8",
        cls: "Radical",
        series: "B/C · Radical",
        tags: ["라디컬", "클래식", "프로토 느낌", "테크니컬"],
        paidTracks: 9,
        paidCar: true
      },
      {
        name: "Porsche Mission R",
        cls: "EV Cup",
        series: "B/C · 전기 컵카",
        tags: ["EV", "컵카", "포르쉐", "하드코어"],
        paidTracks: 9,
        paidCar: true
      }
    ];

    // 토너먼트 상태
    let currentRound = [];
    let nextRound = [];
    let matchIndex = 0;
    let roundSize = 32; // 32강 기준
    let started = false;

    const matchInfoEl = document.getElementById("match-info");
    const matchGridEl = document.getElementById("match-grid");
    const wcStatusEl = document.getElementById("wc-status");
    const winnerTextEl = document.getElementById("winner-text");
    const startBtn = document.getElementById("start-wc");
    const shuffleBtn = document.getElementById("shuffle-wc");
    const restartBtn = document.getElementById("restart-wc");

    function shuffleArray(arr) {
      const copy = arr.slice();
      for (let i = copy.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy;
    }

    function getRoundName(len) {
      if (len === 32) return "32강";
      if (len === 16) return "16강";
      if (len === 8) return "8강";
      if (len === 4) return "4강";
      if (len === 2) return "결승";
      return "우승";
    }

    function renderMatch() {
      if (!started) return;

      if (currentRound.length === 1) {
        // 최종 우승
        const winner = currentRound[0];
        state.winnerCar = winner;

        matchGridEl.innerHTML = "";
        matchInfoEl.textContent = "최종 결과";

        winnerTextEl.textContent = `당신의 이상형 iRacing 스포츠카는 "${winner.name}" 입니다!`;
        wcStatusEl.textContent = "";

        // Step3 활성화 + 요약/비용 계산
        document.getElementById("step3").classList.remove("inactive");
        document.getElementById("step-pill-3").classList.add("active");
        updateSummaryAndCost();
        restartBtn.disabled = false;
        return;
      }

      const roundName = getRoundName(currentRound.length);
      const pairIndex = matchIndex / 2 + 1;
      const totalPairs = currentRound.length / 2;

      matchInfoEl.textContent = `${roundName} - 매치 ${pairIndex} / ${totalPairs}`;
      wcStatusEl.textContent = `남은 차량 수: ${currentRound.length}대`;

      const carA = currentRound[matchIndex];
      const carB = currentRound[matchIndex + 1];

      function carCardHTML(car, id) {
        const tagsHTML = (car.tags || []).map(t => `<span class="tag">#${t}</span>`).join("");
        return `
          <div class="car-card" id="${id}">
            <div class="car-name">${car.name}</div>
            <div class="car-class">${car.cls} · ${car.series}</div>
            <div class="tag-row">${tagsHTML}</div>
            <div class="car-note">이 차가 더 끌리면 클릭하세요.</div>
          </div>
        `;
      }

      matchGridEl.innerHTML = carCardHTML(carA, "carA") + carCardHTML(carB, "carB");

      document.getElementById("carA").onclick = () => chooseWinner(carA);
      document.getElementById("carB").onclick = () => chooseWinner(carB);
    }

    function chooseWinner(car) {
      nextRound.push(car);
      matchIndex += 2;

      if (matchIndex >= currentRound.length) {
        currentRound = nextRound;
        nextRound = [];
        matchIndex = 0;
      }
      renderMatch();
    }

    function initTournament(shuffleFirst = true) {
      winnerTextEl.textContent = "";
      wcStatusEl.textContent = "";
      state.winnerCar = null;

      let cars = baseCars.slice();
      // 32강: baseCars가 32개 이상이라고 가정하고 앞에서 32개만 사용
      if (cars.length > 32) {
        cars = cars.slice(0, 32);
      }
      if (shuffleFirst) {
        cars = shuffleArray(cars);
      }

      currentRound = cars;
      nextRound = [];
      matchIndex = 0;
      roundSize = cars.length;
      started = true;

      restartBtn.disabled = false;
      renderMatch();
    }

    startBtn.addEventListener("click", () => {
      initTournament(true);
    });
    shuffleBtn.addEventListener("click", () => {
      initTournament(true);
    });
    restartBtn.addEventListener("click", () => {
      initTournament(true);
    });

    // ====== STEP 3: 요약 & 비용 계산 ======
    function updateSummaryAndCost() {
      const summaryEl = document.getElementById("summary-text");
      const costBoxEl = document.getElementById("cost-box");
      const costCarEl = document.getElementById("cost-car");
      const costTracksCountEl = document.getElementById("cost-tracks-count");
      const costTracksEl = document.getElementById("cost-tracks");
      const costTotalEl = document.getElementById("cost-total");
      const costTotalDiscountEl = document.getElementById("cost-total-discount");

      if (!state.winnerCar) {
        summaryEl.innerHTML = "먼저 월드컵을 통해 차량을 선택해 주세요.";
        costBoxEl.style.display = "none";
        return;
      }

      const car = state.winnerCar;
      const lic = state.licenseLabel || "선택 안 함";

      // 차량/트랙 유료 여부
      const paidCar = car.paidCar;
      const paidTracks = car.paidTracks || 0;

      const carCost = paidCar ? CAR_PRICE : 0;
      const tracksCost = paidTracks * TRACK_PRICE;
      const total = carCost + tracksCost;

      const itemCount = paidTracks + (paidCar ? 1 : 0);
      const totalDiscount = itemCount >= 6 ? total * (1 - BULK_DISCOUNT) : total;

      summaryEl.innerHTML = `
        <div class="summary-line">
          · 선택한 레이스 성향: <span class="summary-highlight">${lic}</span>
        </div>
        <div class="summary-line">
          · 이상형 월드컵 최종 차량: <span class="summary-highlight">${car.name}</span> (${car.cls})
        </div>
        <div class="summary-line">
          · 대표 시리즈 예시: <span class="summary-highlight">${car.series}</span>
        </div>
        <div class="summary-line">
          · 가정: 해당 차량 1대를 구매하고, 시즌4 2025 기준 비슷한 B클래스 시리즈를
          12주 시즌 대부분 출전한다고 가정했습니다.
        </div>
      `;

      costCarEl.textContent = paidCar ? `$${carCost.toFixed(2)} (유료 차량 1대)` : "$0.00 (무료 베이스 차량)";
      costTracksCountEl.textContent = `${paidTracks}개 (대부분 유료 트랙 기준)`;
      costTracksEl.textContent = `$${tracksCost.toFixed(2)}`;
      costTotalEl.textContent = `$${total.toFixed(2)} (정가 기준 합계)`;

      if (itemCount >= 6) {
        costTotalDiscountEl.textContent =
          `$${totalDiscount.toFixed(2)} (차+트랙 ${itemCount}개 묶음 구매 시 약 15% 할인 가정)`;
      } else {
        costTotalDiscountEl.textContent =
          `$${total.toFixed(2)} (구매 개수가 적어 묶음 할인 거의 없음)`;
      }

      costBoxEl.style.display = "block";

      // 자동으로 3단계로 스크롤
      document.getElementById("step3").scrollIntoView({ behavior: "smooth", block: "start" });
    }
  </script>
</body>
</html>
